<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gastos App</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi"
      crossorigin="anonymous"
    />
    <script
      src="https://kit.fontawesome.com/d5b724907f.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.6.1.js"
      integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI="
      crossorigin="anonymous"
    ></script>
  </head>

  <body>
    <div class="">
      <nav
        class="navbar navbar-dark justify-content-center static-top"
        style="background-color: #4ee688"
      >
        <div class="">
          <i class="fa-solid fa-wallet"></i>
          <a class="navbar-brand" href="index.html">Gastos App </a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarTogglerDemo02"
            aria-controls="navbarTogglerDemo02"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
            <ul class="navbar-nav mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="login.html"
                  >Login</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link active"
                  aria-current="page"
                  href="Servicios.html"
                  >Servicios</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link active"
                  aria-current="page"
                  href="Contacto.html"
                  >Contáctanos</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link active"
                  aria-current="page"
                  href="Nosotros.html"
                  >Nosotros</a
                >
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </div>
    <!-- HOME -->
    <div class="container mt-50" style="margin-top: 20px">
      <div class="card-colums d-flex justify-content-center">
        <div class="card text-center">
          <div class="card-body">
            <h5 class="">Total:</h5>
            <p id="total"></p>
            <canvas id="myChart" width="300" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>
    <!-- <div class="container">
  <div class="card-columns d-flex justify-content-center">
    <div class="card">
      <div class="card-block">
        <h4 class="card-title">Card title</h4>
        <p class="card-text">This is a longer card with supporting text below as a natural lead-in to additional content. This content is a little bit longer.</p>
      </div>
    </div>
    <div class="card">
      <div class="card-block">
        <h4 class="card-title">Card title</h4>
        <p class="card-text">This is a longer card with shorter text.</p>
      </div>
    </div>
  </div>
</div> -->

    <div class="container-fluid mt-5" style="margin-top: 50px">
      <div id="liveAlertPlaceholder"></div>
      <form
        class="row gy-2 gx-1 align-items-center justify-content-center"
        id="myForm"
      >
        <div class="col-3">
          <label class="visually-hidden" for="autoSizingInput"
            >Descripcion</label
          >
          <input
            type="text"
            class="form-control"
            id="autoSizingInput"
            placeholder="Descripcion"
            name="descripcion"
          />
        </div>
        <div class="col-3">
          <label class="visually-hidden" for="autoSizingInputGroup"
            >Monto</label
          >
          <div class="input-group">
            <div class="input-group-text">$</div>
            <input
              type="text"
              class="form-control"
              id="autoSizingInputGroup"
              placeholder="Monto"
              name="monto"
            />
          </div>
        </div>
        <div class="col-2">
          <label class="visually-hidden" for="categoryList">Categoria</label>
          <select class="form-select" id="categoryList" name="id_category">
            <option selected>Categoria</option>
          </select>
        </div>
        <div class="col-2" id="hideMe">
          <label class="visually-hidden" for="autoSizingSelect">User</label>
          <select class="form-select" id="autoSizingSelect" name="id_user">
            <option selected value="1">moises</option>
          </select>
        </div>
        <div class="col-1">
          <button type="submit" class="btn btn-success" id="liveAlertBtn">
            Agregar
          </button>
        </div>
      </form>

      <div class="container mb-5">
        <div class="card mt-2 w-50 mx-auto">
          <div class="card-body" id="gastos">
            <ul class="list-group" id="lista">
              <!-- <li class="list-group-item d-flex justify-content-between align-items-center">
                    Repuestos corolla
                    <span class="badge bg-danger">$75</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    Almuerzo
                    <span class="badge bg-success">$25</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    Farmatodo
                    <span class="badge bg-success">$15</span>
                  </li> -->
            </ul>
          </div>
        </div>
      </div>
    </div>
    <!-- END HOME -->
    <footer
      class="text-center text-white static-bottom"
      style="background-color: #a7d9c1"
    >
      <!-- Grid container -->
      <div class="container p-4 pb-0">
        <!-- Section: Social media -->
        <section class="mb-4">
          <!-- Facebook -->
          <a
            class="btn text-white btn-floating m-1"
            style="background-color: #3b5998"
            href="#!"
            role="button"
            ><i class="fab fa-facebook-f"></i
          ></a>

          <!-- Twitter -->
          <a
            class="btn text-white btn-floating m-1"
            style="background-color: #55acee"
            href="#!"
            role="button"
            ><i class="fab fa-twitter"></i
          ></a>

          <!-- Google -->
          <a
            class="btn text-white btn-floating m-1"
            style="background-color: #dd4b39"
            href="#!"
            role="button"
            ><i class="fab fa-google"></i
          ></a>

          <!-- Instagram -->
          <a
            class="btn text-white btn-floating m-1"
            style="background-color: #ac2bac"
            href="#!"
            role="button"
            ><i class="fab fa-instagram"></i
          ></a>

          <!-- Linkedin -->
          <a
            class="btn text-white btn-floating m-1"
            style="background-color: #0082ca"
            href="#!"
            role="button"
            ><i class="fab fa-linkedin-in"></i
          ></a>
          <!-- Github -->
          <a
            class="btn text-white btn-floating m-1"
            style="background-color: #333333"
            href="#!"
            role="button"
            ><i class="fab fa-github"></i
          ></a>
        </section>
        <!-- Section: Social media -->
      </div>
      <!-- Grid container -->

      <div class="text-center p-3" style="background-color: #145c39">
        © 2022 Copyright:
        <a class="text-white" href="#!">Emiliano Rojas</a>
      </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      let getAllTransaction = () => {
        $.ajax({
          type: "GET",
          url: "http://localhost/src/transaction.php",
          contentType: "application/json",
          async: true,
          success: function (data) {
            transList(data);
          },
          error: function (error) {
            console.log(error);
          },
        });
      };

      let getAllCategory = () => {
        $.ajax({
          type: "GET",
          url: "http://localhost/src/category.php",
          contentType: "application/json",
          async: true,
          success: function (data) {
            categoList(data);
          },
          error: function (error) {
            console.log(error);
          },
        });
      };

      let deleteItem = (urlAPI) => {
        $.ajax({
          type: "DELETE",
          url: urlAPI,
          contentType: "application/json",
          success: function (data) {
            console.log(data);
            getAllTransaction("http://localhost/src/transaction.php");
          },
          error: function (error) {
            console.log(error);
          },
        });
      };

      $(document).ready(function ($) {
        getAllTransaction();
        getAllCategory();

        $("#hideMe").hide();


        $("#myForm").submit(function (e) {
          e.preventDefault(); 

          const formy = document.getElementById('myForm');

          var form = new FormData($("#myForm")[0]);

          $.ajax({
            url: "http://localhost/src/transaction.php",
            method: "POST",
            dataType: "json",
            data: form,
            processData: false,
            contentType: false,
            success: function (result) {
              $("#lista").append(
                '<li value="' +
                  result.id +
                  '" class="list-group-item d-flex justify-content-between align-items-center">' +
                  result.descripcion +
                  '<span class="badge bg-success ms-auto me-5 spanValue" id="' +
                  result.id +
                  '"> $' +
                  result.monto +
                  "</span>" +
                  '<button class="btn text-danger" id="del" value="' +
                  result.id +
                  '"' +
                  ">x</button>" +
                  "</li>"
              );
              var text = $("#total").html();
              let newTotal =
                parseInt(text.replace(/\$/, "")) + parseInt(result.monto);
              $("#total").html("$" + newTotal);
            },
            error: function (er) {},
          });
          
          
          formy.reset();
        }
        );
      });

      function transList(ArregloTransacciones) {
        let i = 0;
        let total = 0;
        while (i < ArregloTransacciones.length) {
          $("#lista").append(
            '<li value="' +
              ArregloTransacciones[i].ID +
              '" class="list-group-item d-flex justify-content-between align-items-center">' +
              ArregloTransacciones[i].description +
              '<span class="badge bg-success ms-auto me-5 spanValue" id="' +
              ArregloTransacciones[i].ID +
              '"> $' +
              ArregloTransacciones[i].amount +
              "</span>" +
              '<button class="btn  text-danger" id="del" value="' +
              ArregloTransacciones[i].ID +
              '"' +
              ">x</button>" +
              "</li>"
          );
          total = total + parseInt(ArregloTransacciones[i].amount);
          i++;
        }
        $("#total").append("$" + total);
      }

      function categoList(ArregloCategoria) {
        let i = 0;
        while (i < ArregloCategoria.length) {
          $("#categoryList").append(
            '<option value="' +
              ArregloCategoria[i].ID +
              '">' +
              ArregloCategoria[i].name +
              "</option>"
          );
          i++;
        }
      }

      $(document).on("click", "#del", function (data) {
        //invocamos funcion que llama metodo DELETE
        deleteButton(data.target.value);

        //buscamos el monto del item
        let spanValor = $("span#" + data.target.value).get();
        let monto = spanValor[0].innerHTML;

        //restamos al total global
        var total = $("#total").html();
        let newTotal =
          parseInt(total.replace(/\$/, "")) - parseInt(monto.replace(/\$/, ""));
        $("#total").html("$" + newTotal);

        //borra li de la lista
        $("li")
          .filter(function () {
            return this.value == data.target.value;
          })
          .remove();
      });

      function deleteButton(idTransaction) {
        let urlDelete =
          "http://localhost/src/transaction.php?id=" + idTransaction;
        deleteItem(urlDelete);
      }

      let getAllTransCategory = () => {
        $.ajax({
          type: "GET",
          url: "http://localhost/src/transactionCategory.php",
          contentType: "application/json",
          async: true,
          success: function (data) {
            let categories = data.map((trans) => trans.category);
            let montos = data.map((trans) => trans.amount);

            var ctx = document.getElementById("myChart");
            var myChart = new Chart(ctx, {
              type: "doughnut",
              data: {
                labels: categories,
                datasets: [
                  {
                    label: "# of Tomatoes",
                    data: montos,
                    backgroundColor: [
                      "rgba(255, 99, 132, 1)",
                      "rgba(54, 162, 235, 0.8)",
                      "rgba(255, 206, 86, 0.8)",
                    ],
                    borderColor: [
                      "rgba(255,99,132,1)",
                      "rgba(54, 162, 235, 1)",
                      "rgba(255, 206, 86, 1)",
                    ],
                    borderWidth: 1,
                    hoverOffset: 4,
                  },
                ],
              },
              options: {
                //cutoutPercentage: 40,
                responsive: false,
              },
            });

          },
          error: function (error) {
            console.log(error);
          },
        });
      };
      getAllTransCategory();
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
